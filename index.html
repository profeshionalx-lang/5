<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grechka ‚Ä¢ Padel</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, onSnapshot, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBVKxWXOxVq_9vIpRr7eQCEJOPv7PKImg0",
            authDomain: "grechka-6bdb7.firebaseapp.com",
            projectId: "grechka-6bdb7",
            storageBucket: "grechka-6bdb7.firebasestorage.app",
            messagingSenderId: "746199017331",
            appId: "1:746199017331:web:2e4e08023cb89484fd4706"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseQuery = query;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        
        window.dispatchEvent(new Event('firebaseReady'));
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /*
         * –í–ê–ñ–ù–û: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Firebase Firestore
         * 
         * –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Firebase Console -> Firestore Database -> Rules
         * –ò —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞:
         * 
         * rules_version = '2';
         * service cloud.firestore {
         *   match /databases/{database}/documents {
         *     match /tournaments/{tournamentId} {
         *       // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º —á–∏—Ç–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä—ã
         *       allow read: if true;
         *       // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä—ã
         *       allow create: if true;
         *       // –†–∞–∑—Ä–µ—à–∞–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å adminToken (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
         *       allow update: if true;
         *       // –†–∞–∑—Ä–µ—à–∞–µ–º —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å adminToken (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
         *       allow delete: if true;
         *     }
         *   }
         * }
         * 
         * –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É adminToken –ø—Ä–∏ update/delete
         */
        
        const { useState, useEffect } = React;

        function App() {
            const [view, setView] = useState('list');
            const [tournaments, setTournaments] = useState([]);
            const [currentTournament, setCurrentTournament] = useState(null);
            const [activeTab, setActiveTab] = useState('stage1');
            const [tournamentId, setTournamentId] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [isAdmin, setIsAdmin] = useState(true);
            const [adminToken, setAdminToken] = useState(null);
            const [showShareModal, setShowShareModal] = useState(false);


            useEffect(() => {
                const handleFirebaseReady = () => setFirebaseReady(true);
                window.addEventListener('firebaseReady', handleFirebaseReady);
                if (window.firebaseDB) setFirebaseReady(true);
                return () => window.removeEventListener('firebaseReady', handleFirebaseReady);
            }, []);

            useEffect(() => {
                if (!firebaseReady) return;
                
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('tournament');
                const token = urlParams.get('admin');
                
                if (id) {
                    setTournamentId(id);
                    if (token) {
                        setAdminToken(token);
                        setIsAdmin(true);
                    } else {
                        setIsAdmin(false);
                    }
                    loadTournamentFromFirebase(id);
                } else {
                    // Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç —Ç—É—Ä–Ω–∏—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                }
            }, [firebaseReady]);

            // Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤
            useEffect(() => {
                if (!firebaseReady || tournamentId) return; // –ù–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –µ—Å–ª–∏ —Å–º–æ—Ç—Ä–∏–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—É—Ä–Ω–∏—Ä
                
                console.log('–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ç—É—Ä–Ω–∏—Ä—ã...');
                const tournamentsRef = window.firebaseCollection(window.firebaseDB, 'tournaments');
                const unsubscribe = window.firebaseOnSnapshot(tournamentsRef, 
                    (snapshot) => {
                        console.log('–ü–æ–ª—É—á–µ–Ω–æ —Ç—É—Ä–Ω–∏—Ä–æ–≤:', snapshot.size);
                        const loadedTournaments = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            // –ò—Å–∫–ª—é—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã
                            if (!data.deleted) {
                                console.log('–¢—É—Ä–Ω–∏—Ä:', data.name, data.id);
                                loadedTournaments.push({
                                    id: data.id,
                                    name: data.name,
                                    createdAt: data.createdAt,
                                    pairs: data.pairs,
                                    courts: data.courts,
                                    status: data.status,
                                    adminToken: data.adminToken
                                });
                            }
                        });
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                        loadedTournaments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        
                        setTournaments(loadedTournaments);
                    },
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤:', error);
                        console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', error.code);
                        console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
                    }
                );
                
                return () => unsubscribe();
            }, [firebaseReady, tournamentId]);

            useEffect(() => {
                if (!firebaseReady || !tournamentId || !currentTournament) return;
                
                const unsubscribe = window.firebaseOnSnapshot(
                    window.firebaseDoc(window.firebaseDB, 'tournaments', tournamentId), 
                    (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            setCurrentTournament(data);
                        }
                    }
                );
                return () => unsubscribe();
            }, [firebaseReady, tournamentId, currentTournament]);

            const loadTournamentFromFirebase = async (id) => {
                try {
                    const docRef = window.firebaseDoc(window.firebaseDB, 'tournaments', id);
                    const docSnap = await window.firebaseGetDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω
                        const urlParams = new URLSearchParams(window.location.search);
                        const token = urlParams.get('admin');
                        
                        if (token && data.adminToken !== token) {
                            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                            setIsAdmin(false);
                        }
                        
                        setCurrentTournament(data);
                        setView('tournament');
                        setActiveTab(data.status === 'stage1' ? 'stage1' : data.status === 'stage2' ? 'stage2' : 'final');
                    } else {
                        alert('–¢—É—Ä–Ω–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        window.history.pushState({}, '', window.location.pathname);
                        setView('list');
                    }
                } catch (error) {
                    console.error('Error loading tournament:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–Ω–∏—Ä–∞');
                }
            };


            const generateToken = () => {
                return Math.random().toString(36).substring(2) + Date.now().toString(36);
            };

            const createTournament = async (tournamentData) => {
                const id = 'tournament_' + Date.now();
                const token = generateToken();
                
                const newTournament = {
                    id: id,
                    adminToken: token,
                    ...tournamentData,
                    status: 'stage1',
                    stage1Groups: generateGroups(tournamentData.pairs, tournamentData.courts),
                    stage2Groups: null,
                    createdAt: new Date().toISOString()
                };

                try {
                    await window.firebaseSetDoc(
                        window.firebaseDoc(window.firebaseDB, 'tournaments', id), 
                        newTournament
                    );
                    
                    console.log('–¢—É—Ä–Ω–∏—Ä —Å–æ–∑–¥–∞–Ω –≤ Firebase:', id);
                    // Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤
                    
                    const link = `${window.location.origin}${window.location.pathname}?tournament=${id}`;
                    
                    setCurrentTournament(newTournament);
                    setTournamentId(id);
                    setAdminToken(token);
                    setIsAdmin(true);
                    setView('tournament');
                    setActiveTab('stage1');
                    
                    setTimeout(() => {
                        setShowShareModal(true);
                    }, 500);
                    
                    setTimeout(() => {
                        alert(`–¢—É—Ä–Ω–∏—Ä —Å–æ–∑–¥–∞–Ω! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π:\n\n${link}`);
                    }, 500);
                } catch (error) {
                    console.error('Error creating tournament:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞');
                }
            };

            const generateGroups = (pairs, totalCourts) => {
                const groups = [];
                const pairsPerGroup = 4;
                const numGroups = Math.ceil(pairs.length / pairsPerGroup);
                const courtsPerGroup = Math.floor(totalCourts / numGroups);

                for (let i = 0; i < numGroups; i++) {
                    const groupPairs = pairs.slice(i * pairsPerGroup, (i + 1) * pairsPerGroup);
                    const startCourt = i * courtsPerGroup + 1;
                    const matches = generateMatches(groupPairs, startCourt, courtsPerGroup);
                    
                    groups.push({
                        id: i,
                        name: String.fromCharCode(65 + i),
                        pairs: groupPairs.map(p => ({
                            ...p,
                            played: 0,
                            won: 0,
                            lost: 0,
                            points: 0,
                            gamesWon: 0,
                            gamesLost: 0,
                            gamesDiff: 0
                        })),
                        matches: matches
                    });
                }

                return groups;
            };

            const generateMatches = (pairs, startCourt, courtsPerGroup) => {
                if (pairs.length !== 4) return [];
                
                const courtsForGroup = courtsPerGroup >= 2 ? 2 : 1;
                const court1 = startCourt;
                const court2 = courtsForGroup === 2 ? startCourt + 1 : startCourt;
                
                return [
                    { round: 1, pair1: pairs[0], pair2: pairs[1], court: court1, set1p1: '', set1p2: '' },
                    { round: 1, pair1: pairs[2], pair2: pairs[3], court: court2, set1p1: '', set1p2: '' },
                    { round: 2, pair1: pairs[0], pair2: pairs[2], court: court1, set1p1: '', set1p2: '' },
                    { round: 2, pair1: pairs[1], pair2: pairs[3], court: court2, set1p1: '', set1p2: '' },
                    { round: 3, pair1: pairs[0], pair2: pairs[3], court: court1, set1p1: '', set1p2: '' },
                    { round: 3, pair1: pairs[1], pair2: pairs[2], court: court2, set1p1: '', set1p2: '' },
                ];
            };

            const updateMatchResult = async (groupId, matchIndex, result, stage) => {
                const groupsKey = stage === 1 ? 'stage1Groups' : 'stage2Groups';
                const updatedGroups = [...currentTournament[groupsKey]];
                const group = updatedGroups[groupId];
                
                group.matches[matchIndex] = { ...group.matches[matchIndex], ...result };
                
                group.pairs = group.pairs.map(pair => ({
                    ...pair,
                    played: 0,
                    won: 0,
                    lost: 0,
                    points: 0,
                    gamesWon: 0,
                    gamesLost: 0,
                    gamesDiff: 0
                }));

                group.matches.forEach(match => {
                    if (match.set1p1 !== '' && match.set1p2 !== '') {
                        const p1Games = parseInt(match.set1p1) || 0;
                        const p2Games = parseInt(match.set1p2) || 0;
                        
                        const p1Idx = group.pairs.findIndex(p => p.id === match.pair1.id);
                        const p2Idx = group.pairs.findIndex(p => p.id === match.pair2.id);

                        if (p1Idx !== -1 && p2Idx !== -1) {
                            group.pairs[p1Idx].played++;
                            group.pairs[p2Idx].played++;
                            group.pairs[p1Idx].gamesWon += p1Games;
                            group.pairs[p1Idx].gamesLost += p2Games;
                            group.pairs[p2Idx].gamesWon += p2Games;
                            group.pairs[p2Idx].gamesLost += p1Games;

                            if (p1Games > p2Games) {
                                group.pairs[p1Idx].won++;
                                group.pairs[p1Idx].points += 3;
                                group.pairs[p2Idx].lost++;
                            } else if (p2Games > p1Games) {
                                group.pairs[p2Idx].won++;
                                group.pairs[p2Idx].points += 3;
                                group.pairs[p1Idx].lost++;
                            }

                            group.pairs[p1Idx].gamesDiff = group.pairs[p1Idx].gamesWon - group.pairs[p1Idx].gamesLost;
                            group.pairs[p2Idx].gamesDiff = group.pairs[p2Idx].gamesWon - group.pairs[p2Idx].gamesLost;
                        }
                    }
                });

                group.pairs.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gamesDiff !== a.gamesDiff) return b.gamesDiff - a.gamesDiff;
                    return b.gamesWon - a.gamesWon;
                });

                updatedGroups[groupId] = group;

                try {
                    await window.firebaseUpdateDoc(
                        window.firebaseDoc(window.firebaseDB, 'tournaments', tournamentId),
                        { [groupsKey]: updatedGroups }
                    );
                } catch (error) {
                    console.error('Error updating match:', error);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞');
                }
            };

            const generateStage2 = async () => {
                const allPairs = [];
                currentTournament.stage1Groups.forEach(group => {
                    group.pairs.forEach(pair => {
                        allPairs.push({ ...pair });
                    });
                });

                allPairs.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gamesDiff !== a.gamesDiff) return b.gamesDiff - a.gamesDiff;
                    return b.gamesWon - a.gamesWon;
                });

                const pairsForStage2 = allPairs.map(p => ({
                    id: p.id,
                    number: p.number,
                    player1: p.player1,
                    player2: p.player2
                }));

                const stage2Groups = generateGroups(pairsForStage2, currentTournament.courts);

                try {
                    await window.firebaseUpdateDoc(
                        window.firebaseDoc(window.firebaseDB, 'tournaments', tournamentId),
                        {
                            stage2Groups: stage2Groups,
                            status: 'stage2'
                        }
                    );
                    setActiveTab('stage2');
                } catch (error) {
                    console.error('Error generating stage 2:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ç–∞–ø–∞ 2');
                }
            };

            const completeTournament = async () => {
                try {
                    await window.firebaseUpdateDoc(
                        window.firebaseDoc(window.firebaseDB, 'tournaments', tournamentId),
                        { status: 'completed' }
                    );
                } catch (error) {
                    console.error('Error completing tournament:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞');
                }
            };

            const deleteTournament = async (id) => {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—É—Ä–Ω–∏—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                    return;
                }
                
                try {
                    await window.firebaseUpdateDoc(
                        window.firebaseDoc(window.firebaseDB, 'tournaments', id),
                        { deleted: true }
                    );
                    
                    alert('–¢—É—Ä–Ω–∏—Ä —É–¥–∞–ª–µ–Ω');
                    
                    if (tournamentId === id) {
                        setView('list');
                        setCurrentTournament(null);
                        setTournamentId(null);
                        window.history.pushState({}, '', window.location.pathname);
                    }
                } catch (error) {
                    console.error('Error deleting tournament:', error);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞');
                }
            };

            const updateTournamentName = async (id, newName) => {
                if (!newName.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞');
                    return;
                }
                
                try {
                    await window.firebaseUpdateDoc(
                        window.firebaseDoc(window.firebaseDB, 'tournaments', id),
                        { name: newName }
                    );
                } catch (error) {
                    console.error('Error updating tournament name:', error);
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è');
                }
            };

            const openShareModal = () => {
                setShowShareModal(true);
            };

            if (!firebaseReady) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center">
                        <div className="text-white text-2xl">–ó–∞–≥—Ä—É–∑–∫–∞ Firebase...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="mb-8 flex items-center justify-between">
                            <div>
                                <h1 className="text-4xl font-bold text-white mb-2">Grechka ‚Ä¢ Padel</h1>
                                <p className="text-gray-400">–°–∏—Å—Ç–µ–º–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤</p>
                            </div>
                            {tournamentId && view === 'tournament' && isAdmin && (
                                <button 
                                    onClick={openShareModal}
                                    className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-2xl font-semibold hover:shadow-2xl transition-all"
                                >
                                    üìã –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
                                </button>
                            )}
                        </div>

                        {view === 'list' && (
                            <TournamentList 
                                tournaments={tournaments}
                                onCreateNew={() => setView('create')}
                                onSelectTournament={async (t) => {
                                    await loadTournamentFromFirebase(t.id);
                                    setTournamentId(t.id);
                                }}
                                isAdmin={isAdmin}
                                onDeleteTournament={deleteTournament}
                            />
                        )}

                        {view === 'create' && (
                            <CreateTournament 
                                onSubmit={createTournament}
                                onCancel={() => setView('list')}
                            />
                        )}

                        {view === 'tournament' && currentTournament && (
                            <TournamentView 
                                tournament={currentTournament}
                                activeTab={activeTab}
                                onTabChange={setActiveTab}
                                onUpdateMatch={updateMatchResult}
                                onGenerateStage2={generateStage2}
                                onComplete={completeTournament}
                                onBack={() => {
                                    setView('list');
                                    setCurrentTournament(null);
                                    setTournamentId(null);
                                    window.history.pushState({}, '', window.location.pathname);
                                }}
                                isAdmin={isAdmin}
                                onUpdateName={updateTournamentName}
                                onDelete={deleteTournament}
                            />
                        )}
                    </div>

                    {showShareModal && (
                        <ShareModal 
                            tournamentId={tournamentId}
                            adminToken={adminToken}
                            tournamentName={currentTournament?.name || '–¢—É—Ä–Ω–∏—Ä'}
                            onClose={() => setShowShareModal(false)}
                        />
                    )}
                </div>
            );
        }


        function ShareModal({ tournamentId, adminToken, tournamentName, onClose }) {
            const [copied, setCopied] = useState('');
            
            const adminLink = `${window.location.origin}${window.location.pathname}?tournament=${tournamentId}&admin=${adminToken}`;
            const viewLink = `${window.location.origin}${window.location.pathname}?tournament=${tournamentId}`;

            const copyLink = (link, type) => {
                navigator.clipboard.writeText(link);
                setCopied(type);
                setTimeout(() => setCopied(''), 2000);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-8 max-w-2xl w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-900">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç—É—Ä–Ω–∏—Ä–æ–º</h3>
                                <p className="text-gray-600 mt-1">{tournamentName}</p>
                            </div>
                            <button 
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 transition-colors"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div className="border-2 border-gray-200 rounded-2xl p-5 hover:border-green-300 transition-colors">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-900">–ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                                            <div className="text-sm text-gray-500">–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ç—É—Ä–Ω–∏—Ä–æ–º</div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => copyLink(adminLink, 'admin')}
                                        className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold text-sm transition-colors flex items-center gap-2"
                                    >
                                        {copied === 'admin' ? (
                                            <>
                                                <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                                <span className="text-green-600">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                </svg>
                                                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                            </>
                                        )}
                                    </button>
                                </div>
                                <div className="bg-gray-50 rounded-lg p-3 font-mono text-xs text-gray-600 break-all">
                                    {adminLink}
                                </div>
                            </div>

                            <div className="border-2 border-gray-200 rounded-2xl p-5 hover:border-blue-300 transition-colors">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-900">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                                            <div className="text-sm text-gray-500">–ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –Ω–æ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => copyLink(viewLink, 'view')}
                                        className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold text-sm transition-colors flex items-center gap-2"
                                    >
                                        {copied === 'view' ? (
                                            <>
                                                <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                                <span className="text-green-600">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                </svg>
                                                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                            </>
                                        )}
                                    </button>
                                </div>
                                <div className="bg-gray-50 rounded-lg p-3 font-mono text-xs text-gray-600 break-all">
                                    {viewLink}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function TournamentList({ tournaments, onCreateNew, onSelectTournament, isAdmin, onDeleteTournament }) {
            return (
                <div>
                    {isAdmin && (
                        <div className="flex justify-between items-center mb-8">
                            <button 
                                className="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-8 py-4 rounded-2xl font-semibold hover:shadow-2xl hover:scale-105 transition-all duration-200"
                                onClick={onCreateNew}
                            >
                                + –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
                            </button>
                        </div>
                    )}

                    {tournaments.length === 0 ? (
                        <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-20 text-center border border-gray-700">
                            <div className="text-8xl mb-6">üéæ</div>
                            <h3 className="text-2xl font-bold text-white mb-3">–ù–µ—Ç —Ç—É—Ä–Ω–∏—Ä–æ–≤</h3>
                            <p className="text-gray-400">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ç—É—Ä–Ω–∏—Ä</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {tournaments.map(t => (
                                <div 
                                    key={t.id} 
                                    className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl p-6 hover:shadow-2xl transition-all duration-200 relative"
                                >
                                    <div onClick={() => onSelectTournament(t)} className="cursor-pointer">
                                        <h3 className="text-2xl font-bold text-white mb-4">{t.name}</h3>
                                        <div className="text-blue-100 space-y-2 mb-4">
                                            <div className="flex items-center gap-2">
                                                <span>üìÖ</span>
                                                <span>{new Date(t.createdAt).toLocaleDateString('ru-RU')}</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span>üë•</span>
                                                <span>{t.pairs.length} –ø–∞—Ä</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span>üèüÔ∏è</span>
                                                <span>{t.courts} –∫–æ—Ä—Ç–æ–≤</span>
                                            </div>
                                        </div>
                                        <span className={`inline-block px-4 py-2 rounded-full text-sm font-bold ${
                                            t.status === 'completed' 
                                                ? 'bg-green-400 text-green-900' 
                                                : 'bg-yellow-400 text-yellow-900'
                                        }`}>
                                            {t.status === 'completed' ? '‚úì –ó–∞–≤–µ—Ä—à–µ–Ω' : t.status === 'stage2' ? '–≠—Ç–∞–ø 2' : '–≠—Ç–∞–ø 1'}
                                        </span>
                                    </div>
                                    {isAdmin && (
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                onDeleteTournament(t.id);
                                            }}
                                            className="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-all"
                                            title="–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function CreateTournament({ onSubmit, onCancel }) {
            const [name, setName] = useState('');
            const [numPairs, setNumPairs] = useState(8);
            const [courts, setCourts] = useState(2);
            const [pairs, setPairs] = useState([]);

            useEffect(() => {
                const newPairs = [];
                for (let i = 0; i < numPairs; i++) {
                    newPairs.push({
                        id: i + 1,
                        number: i + 1,
                        player1: '',
                        player2: ''
                    });
                }
                setPairs(newPairs);
            }, [numPairs]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞');
                    return;
                }
                // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä —Å –ø—É—Å—Ç—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –∏–≥—Ä–æ–∫–æ–≤
                onSubmit({ name, courts, pairs });
            };

            const updatePair = (index, field, value) => {
                const newPairs = [...pairs];
                newPairs[index][field] = value;
                setPairs(newPairs);
            };

            return (
                <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-8 border border-gray-700">
                    <h2 className="text-3xl font-bold text-white mb-8">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä</h2>
                    <div className="space-y-6">
                        <div>
                            <label className="block font-semibold mb-3 text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                            <input 
                                type="text" 
                                className="w-full p-4 bg-gray-700 border-2 border-gray-600 rounded-2xl text-white placeholder-gray-400 focus:border-blue-500 outline-none transition-all"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–µ–º–ø–∏–æ–Ω–∞—Ç –∫–ª—É–±–∞"
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-6">
                            <div>
                                <label className="block font-semibold mb-3 text-gray-300">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä</label>
                                <select 
                                    className="w-full p-4 bg-gray-700 border-2 border-gray-600 rounded-2xl text-white focus:border-blue-500 outline-none transition-all"
                                    value={numPairs} 
                                    onChange={(e) => setNumPairs(parseInt(e.target.value))}
                                >
                                    <option value={8}>8 –ø–∞—Ä</option>
                                    <option value={12}>12 –ø–∞—Ä</option>
                                    <option value={16}>16 –ø–∞—Ä</option>
                                    <option value={20}>20 –ø–∞—Ä</option>
                                </select>
                            </div>

                            <div>
                                <label className="block font-semibold mb-3 text-gray-300">–ö–æ—Ä—Ç–æ–≤</label>
                                <input 
                                    type="number" 
                                    min="1" 
                                    max="10"
                                    className="w-full p-4 bg-gray-700 border-2 border-gray-600 rounded-2xl text-white focus:border-blue-500 outline-none transition-all"
                                    value={courts}
                                    onChange={(e) => setCourts(parseInt(e.target.value))}
                                />
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-xl mb-4 text-white">–ü–∞—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {pairs.map((pair, idx) => (
                                    <div key={pair.id} className="flex gap-3 items-center">
                                        <span className="font-semibold text-blue-400 min-w-20">#{pair.number}</span>
                                        <input 
                                            type="text"
                                            className="flex-1 p-3 bg-gray-700 border-2 border-gray-600 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 outline-none transition-all"
                                            placeholder="–ò–≥—Ä–æ–∫ 1"
                                            value={pair.player1}
                                            onChange={(e) => updatePair(idx, 'player1', e.target.value)}
                                        />
                                        <span className="text-gray-500">/</span>
                                        <input 
                                            type="text"
                                            className="flex-1 p-3 bg-gray-700 border-2 border-gray-600 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 outline-none transition-all"
                                            placeholder="–ò–≥—Ä–æ–∫ 2"
                                            value={pair.player2}
                                            onChange={(e) => updatePair(idx, 'player2', e.target.value)}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex gap-4 pt-4">
                            <button 
                                onClick={handleSubmit}
                                className="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-8 py-4 rounded-2xl font-bold hover:shadow-2xl hover:scale-105 transition-all"
                            >
                                –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
                            </button>
                            <button 
                                onClick={onCancel}
                                className="px-8 py-4 bg-gray-700 text-white rounded-2xl font-bold hover:bg-gray-600 transition-all"
                            >
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function TournamentView({ tournament, activeTab, onTabChange, onUpdateMatch, onGenerateStage2, onComplete, onBack, isAdmin, onUpdateName, onDelete }) {
            const [isEditingName, setIsEditingName] = useState(false);
            const [editedName, setEditedName] = useState(tournament.name);
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–≥—Ä - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —ç—Ç–∞–ø—É 2 –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
            const allStage1Completed = true;

            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–≥—Ä —ç—Ç–∞–ø–∞ 2 - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Ñ–∏–Ω–∞–ª—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
            const allStage2Completed = true;

            const handleSaveName = () => {
                if (editedName.trim() && editedName !== tournament.name) {
                    onUpdateName(tournament.id, editedName.trim());
                }
                setIsEditingName(false);
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-8">
                        {isAdmin ? (
                            <button 
                                className="bg-gray-700 text-white px-6 py-3 rounded-2xl font-semibold hover:bg-gray-600 transition-all"
                                onClick={onBack}
                            >
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        ) : (
                            <div></div>
                        )}
                        
                        <div className="flex items-center gap-3">
                            {isEditingName && isAdmin ? (
                                <div className="flex items-center gap-2">
                                    <input
                                        type="text"
                                        value={editedName}
                                        onChange={(e) => setEditedName(e.target.value)}
                                        className="text-2xl font-bold text-white bg-gray-700 px-4 py-2 rounded-xl border-2 border-blue-500 outline-none"
                                        autoFocus
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') handleSaveName();
                                        }}
                                    />
                                    <button
                                        onClick={handleSaveName}
                                        className="bg-green-500 text-white px-4 py-2 rounded-xl hover:bg-green-600 transition-all"
                                    >
                                        ‚úì
                                    </button>
                                    <button
                                        onClick={() => {
                                            setIsEditingName(false);
                                            setEditedName(tournament.name);
                                        }}
                                        className="bg-gray-600 text-white px-4 py-2 rounded-xl hover:bg-gray-700 transition-all"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            ) : (
                                <>
                                    <h2 className="text-3xl font-bold text-white">{tournament.name}</h2>
                                    {isAdmin && (
                                        <button
                                            onClick={() => setIsEditingName(true)}
                                            className="text-gray-400 hover:text-white transition-all"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                            </svg>
                                        </button>
                                    )}
                                </>
                            )}
                        </div>
                        
                        {isAdmin ? (
                            <button
                                onClick={() => onDelete(tournament.id)}
                                className="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-2xl transition-all flex items-center gap-2"
                                title="–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        ) : (
                            <div></div>
                        )}
                    </div>

                    <div className="flex gap-3 mb-8 overflow-x-auto">
                        <button 
                            className={`px-6 py-3 font-bold rounded-2xl transition-all whitespace-nowrap ${
                                activeTab === 'stage1' 
                                    ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' 
                                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            }`}
                            onClick={() => onTabChange('stage1')}
                        >
                            –≠—Ç–∞–ø 1
                        </button>
                        <button 
                            className={`px-6 py-3 font-bold rounded-2xl transition-all whitespace-nowrap ${
                                activeTab === 'table1' 
                                    ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' 
                                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            } ${!allStage1Completed && 'opacity-50 cursor-not-allowed'}`}
                            onClick={() => allStage1Completed && onTabChange('table1')}
                            disabled={!allStage1Completed}
                        >
                            –¢–∞–±–ª–∏—Ü–∞ 1
                        </button>
                        {tournament.stage2Groups && (
                            <>
                                <button 
                                    className={`px-6 py-3 font-bold rounded-2xl transition-all whitespace-nowrap ${
                                        activeTab === 'stage2' 
                                            ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' 
                                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                    }`}
                                    onClick={() => onTabChange('stage2')}
                                >
                                    –≠—Ç–∞–ø 2
                                </button>
                                <button 
                                    className={`px-6 py-3 font-bold rounded-2xl transition-all whitespace-nowrap ${
                                        activeTab === 'final' 
                                            ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' 
                                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                    } ${!allStage2Completed && 'opacity-50 cursor-not-allowed'}`}
                                    onClick={() => allStage2Completed && onTabChange('final')}
                                    disabled={!allStage2Completed}
                                >
                                    –§–∏–Ω–∞–ª
                                </button>
                            </>
                        )}
                    </div>

                    {activeTab === 'stage1' && (
                        <StageView 
                            groups={tournament.stage1Groups}
                            stage={1}
                            onUpdateMatch={onUpdateMatch}
                            isAdmin={isAdmin}
                        />
                    )}

                    {activeTab === 'table1' && (
                        <OverallTable 
                            groups={tournament.stage1Groups}
                            onGenerateStage2={onGenerateStage2}
                            showButton={!tournament.stage2Groups && isAdmin}
                        />
                    )}

                    {activeTab === 'stage2' && tournament.stage2Groups && (
                        <StageView 
                            groups={tournament.stage2Groups}
                            stage={2}
                            onUpdateMatch={onUpdateMatch}
                            isAdmin={isAdmin}
                        />
                    )}

                    {activeTab === 'final' && tournament.stage2Groups && (
                        <FinalTable 
                            groups={tournament.stage2Groups}
                            onComplete={onComplete}
                            isCompleted={tournament.status === 'completed'}
                            isAdmin={isAdmin}
                        />
                    )}
                </div>
            );
        }

        function StageView({ groups, stage, onUpdateMatch, isAdmin }) {
            const colors = [
                'from-rose-500 to-pink-500',
                'from-blue-500 to-cyan-500',
                'from-emerald-500 to-teal-500',
                'from-purple-500 to-indigo-500',
                'from-orange-500 to-amber-500'
            ];

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {groups.map((group, idx) => (
                        <GroupView 
                            key={group.id} 
                            group={group} 
                            stage={stage} 
                            onUpdateMatch={onUpdateMatch}
                            colorClass={colors[idx % colors.length]}
                            isAdmin={isAdmin}
                        />
                    ))}
                </div>
            );
        }

        function GroupView({ group, stage, onUpdateMatch, colorClass, isAdmin }) {
            const [editingMatch, setEditingMatch] = useState(null);

            return (
                <div className={`bg-gradient-to-br ${colorClass} rounded-3xl p-6 shadow-2xl`}>
                    <div className="text-3xl font-black text-white mb-6 text-center">
                        –ì–†–£–ü–ü–ê {group.name}
                    </div>
                    
                    <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl p-4 mb-6">
                        <table className="w-full text-white text-sm">
                            <thead>
                                <tr className="border-b border-white border-opacity-30">
                                    <th className="p-2 text-left font-bold">–ú</th>
                                    <th className="p-2 text-left font-bold">–ü–∞—Ä–∞</th>
                                    <th className="p-2 text-center font-bold">–ò</th>
                                    <th className="p-2 text-center font-bold">–û</th>
                                    <th className="p-2 text-center font-bold">+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                                {group.pairs.map((pair, idx) => (
                                    <tr key={pair.id} className="border-b border-white border-opacity-20">
                                        <td className="p-2"><span className="font-black text-lg">{idx + 1}</span></td>
                                        <td className="p-2">
                                            <div className="font-bold">#{pair.number}</div>
                                            <div className="text-xs opacity-90">{pair.player1}/{pair.player2}</div>
                                        </td>
                                        <td className="p-2 text-center">{pair.played}</td>
                                        <td className="p-2 text-center"><span className="font-black text-lg">{pair.points}</span></td>
                                        <td className={`p-2 text-center font-bold ${pair.gamesDiff > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                            {pair.gamesDiff > 0 ? '+' : ''}{pair.gamesDiff}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="space-y-3">
                        {[1, 2, 3].map(round => (
                            <div key={round}>
                                <div className="text-white font-bold mb-2 text-sm opacity-90">–†–ê–£–ù–î {round}</div>
                                {group.matches.filter(m => m.round === round).map((match, idx) => (
                                    <Match 
                                        key={idx}
                                        match={match}
                                        onEdit={() => setEditingMatch({ match, idx: group.matches.indexOf(match) })}
                                        isAdmin={isAdmin}
                                    />
                                ))}
                            </div>
                        ))}
                    </div>

                    {editingMatch && (
                        <ScoreModal 
                            match={editingMatch.match}
                            onSave={(result) => {
                                onUpdateMatch(group.id, editingMatch.idx, result, stage);
                                setEditingMatch(null);
                            }}
                            onClose={() => setEditingMatch(null)}
                        />
                    )}
                </div>
            );
        }

        function Match({ match, onEdit, isAdmin }) {
            const hasResult = match.set1p1 !== '' && match.set1p2 !== '';
            const p1Games = parseInt(match.set1p1) || 0;
            const p2Games = parseInt(match.set1p2) || 0;
            const winner = hasResult ? (p1Games > p2Games ? 1 : p1Games < p2Games ? 2 : 0) : 0;

            return (
                <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-3 flex justify-between items-center mb-2">
                    <div className="flex items-center gap-3 text-white">
                        <span className="bg-white bg-opacity-30 px-3 py-1 rounded-full text-xs font-bold">
                            –ö{match.court}
                        </span>
                        <span className="text-sm">
                            <strong className={winner === 1 ? 'text-green-300' : ''}>
                                #{match.pair1.number}
                            </strong>
                            {' vs '}
                            <strong className={winner === 2 ? 'text-green-300' : ''}>
                                #{match.pair2.number}
                            </strong>
                        </span>
                    </div>
                    
                    {hasResult ? (
                        <div className="flex gap-3 items-center">
                            <span className="text-white font-black text-lg">
                                {match.set1p1}:{match.set1p2}
                            </span>
                            {isAdmin && (
                                <button 
                                    className="bg-white bg-opacity-30 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-opacity-40"
                                    onClick={onEdit}
                                >
                                    ‚úé
                                </button>
                            )}
                        </div>
                    ) : (
                        isAdmin ? (
                            <button 
                                className="bg-white text-gray-900 px-4 py-2 rounded-lg text-sm font-bold hover:bg-opacity-90"
                                onClick={onEdit}
                            >
                                –í–≤–µ—Å—Ç–∏
                            </button>
                        ) : (
                            <span className="text-white text-sm opacity-50">
                                –û–∂–∏–¥–∞–Ω–∏–µ
                            </span>
                        )
                    )}
                </div>
            );
        }

        function ScoreModal({ match, onSave, onClose }) {
            const [set1p1, setSet1p1] = useState(match.set1p1);
            const [set1p2, setSet1p2] = useState(match.set1p2);

            const handleSave = () => {
                if (set1p1 === '' || set1p2 === '') {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Å—á–µ—Ç');
                    return;
                }
                onSave({ set1p1, set1p2 });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-8 max-w-md w-full border border-gray-700" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold text-white mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞</h3>
                        <p className="mb-6 text-gray-300">
                            <strong>#{match.pair1.number}</strong> vs <strong>#{match.pair2.number}</strong>
                        </p>
                        
                        <div className="mb-8">
                            <label className="block font-bold mb-3 text-white">–°—á–µ—Ç:</label>
                            <div className="flex items-center gap-4 justify-center">
                                <input 
                                    type="number" 
                                    min="0" 
                                    max="20"
                                    className="w-20 h-20 p-2 bg-gray-700 border-2 border-blue-500 rounded-2xl text-center text-white text-3xl font-bold focus:border-blue-400 outline-none"
                                    value={set1p1}
                                    onChange={(e) => setSet1p1(e.target.value)}
                                />
                                <span className="text-white text-4xl font-bold">:</span>
                                <input 
                                    type="number" 
                                    min="0" 
                                    max="20"
                                    className="w-20 h-20 p-2 bg-gray-700 border-2 border-purple-500 rounded-2xl text-center text-white text-3xl font-bold focus:border-purple-400 outline-none"
                                    value={set1p2}
                                    onChange={(e) => setSet1p2(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="flex gap-4">
                            <button 
                                className="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-6 py-4 rounded-2xl font-bold hover:shadow-2xl transition-all"
                                onClick={handleSave}
                            >
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button 
                                className="px-6 py-4 bg-gray-700 text-white rounded-2xl font-bold hover:bg-gray-600 transition-all"
                                onClick={onClose}
                            >
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function OverallTable({ groups, onGenerateStage2, showButton }) {
            const allPairs = [];
            groups.forEach(group => {
                group.pairs.forEach(pair => {
                    allPairs.push({ ...pair, group: group.name });
                });
            });

            allPairs.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.gamesDiff !== a.gamesDiff) return b.gamesDiff - a.gamesDiff;
                return b.gamesWon - a.gamesWon;
            });

            return (
                <div className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl p-8 shadow-2xl">
                    <h3 className="text-3xl font-black text-white mb-6">–û–ë–©–ê–Ø –¢–ê–ë–õ–ò–¶–ê</h3>
                    
                    <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl overflow-hidden mb-6">
                        <table className="w-full text-white">
                            <thead>
                                <tr className="border-b border-white border-opacity-30">
                                    <th className="p-4 text-left font-bold">–ú</th>
                                    <th className="p-4 text-left font-bold">–ì—Ä</th>
                                    <th className="p-4 text-left font-bold">–ü–∞—Ä–∞</th>
                                    <th className="p-4 text-center font-bold">–û</th>
                                    <th className="p-4 text-center font-bold">+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                                {allPairs.map((pair, idx) => (
                                    <tr key={pair.id} className="border-b border-white border-opacity-20">
                                        <td className="p-4"><span className="font-black text-2xl">{idx + 1}</span></td>
                                        <td className="p-4 font-bold">{pair.group}</td>
                                        <td className="p-4">
                                            <div className="font-bold">#{pair.number}</div>
                                            <div className="text-sm opacity-90">{pair.player1}/{pair.player2}</div>
                                        </td>
                                        <td className="p-4 text-center"><span className="font-black text-xl">{pair.points}</span></td>
                                        <td className={`p-4 text-center font-bold text-lg ${pair.gamesDiff > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                            {pair.gamesDiff > 0 ? '+' : ''}{pair.gamesDiff}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {showButton && (
                        <button 
                            className="w-full bg-white text-purple-600 px-8 py-4 rounded-2xl font-black text-lg hover:shadow-2xl hover:scale-105 transition-all"
                            onClick={onGenerateStage2}
                        >
                            –ü–ï–†–ï–ô–¢–ò –ö –≠–¢–ê–ü–£ 2 ‚Üí
                        </button>
                    )}
                </div>
            );
        }

        function FinalTable({ groups, onComplete, isCompleted, isAdmin }) {
            const finalStandings = [];
            
            groups.forEach((group, groupIdx) => {
                const sortedPairs = [...group.pairs].sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.gamesDiff !== a.gamesDiff) return b.gamesDiff - a.gamesDiff;
                    return b.gamesWon - a.gamesWon;
                });

                sortedPairs.forEach((pair, pairIdx) => {
                    finalStandings.push({
                        ...pair,
                        finalPlace: groupIdx * 4 + pairIdx + 1,
                        group: group.name
                    });
                });
            });

            finalStandings.sort((a, b) => a.finalPlace - b.finalPlace);

            return (
                <div className="bg-gradient-to-br from-yellow-500 via-orange-500 to-red-500 rounded-3xl p-8 shadow-2xl">
                    <h3 className="text-4xl font-black text-white mb-6 text-center">üèÜ –§–ò–ù–ê–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê</h3>
                    
                    <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl overflow-hidden mb-6">
                        <table className="w-full text-white">
                            <thead>
                                <tr className="border-b border-white border-opacity-30">
                                    <th className="p-4 text-left font-bold">–ú–µ—Å—Ç–æ</th>
                                    <th className="p-4 text-left font-bold">–ü–∞—Ä–∞</th>
                                    <th className="p-4 text-center font-bold">–û—á–∫–∏</th>
                                    <th className="p-4 text-center font-bold">+/-</th>
                                </tr>
                            </thead>
                            <tbody>
                                {finalStandings.map((pair) => {
                                    const badgeColor = 
                                        pair.finalPlace === 1 ? 'bg-yellow-300 text-yellow-900' :
                                        pair.finalPlace === 2 ? 'bg-gray-300 text-gray-900' :
                                        pair.finalPlace === 3 ? 'bg-orange-300 text-orange-900' : 'bg-white bg-opacity-50';

                                    return (
                                        <tr key={pair.id} className="border-b border-white border-opacity-20">
                                            <td className="p-4">
                                                <span className={`inline-flex items-center justify-center w-12 h-12 rounded-full ${badgeColor} font-black text-xl`}>
                                                    {pair.finalPlace}
                                                </span>
                                            </td>
                                            <td className="p-4">
                                                <div className="font-bold text-lg">#{pair.number}</div>
                                                <div className="text-sm opacity-90">{pair.player1}/{pair.player2}</div>
                                            </td>
                                            <td className="p-4 text-center"><span className="font-black text-2xl">{pair.points}</span></td>
                                            <td className={`p-4 text-center font-bold text-xl ${pair.gamesDiff > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                {pair.gamesDiff > 0 ? '+' : ''}{pair.gamesDiff}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {!isCompleted && isAdmin && (
                        <button 
                            className="w-full bg-white text-orange-600 px-8 py-4 rounded-2xl font-black text-lg hover:shadow-2xl hover:scale-105 transition-all"
                            onClick={onComplete}
                        >
                            ‚úì –ó–ê–í–ï–†–®–ò–¢–¨ –¢–£–†–ù–ò–†
                        </button>
                    )}
                    
                    {isCompleted && (
                        <div className="text-center py-8 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl">
                            <div className="text-6xl mb-4">üèÜ</div>
                            <div className="text-white text-3xl font-black">–¢–£–†–ù–ò–† –ó–ê–í–ï–†–®–ï–ù!</div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
